workflows:
  android_production:
    name: ðŸš€ Android Production Build
    environment:
      vars:
        FLUTTER_VERSION: "3.32.4"
        GRADLE_VERSION: "7.6"  # ØªÙ… Ø§Ù„ØªØºÙŠÙŠØ± Ø¥Ù„Ù‰ Ø¥ØµØ¯Ø§Ø± Ø£Ù‚Ø¯Ù… ÙˆØ£ÙƒØ«Ø± Ø§Ø³ØªÙ‚Ø±Ø§Ø±Ø§Ù‹
        KOTLIN_VERSION: "1.7.20"  # Ù…Ø¹Ø¯Ù„ Ù„ÙŠØªÙˆØ§ÙÙ‚ Ù…Ø¹ Gradle 7.6
        FIREBASE_API_KEY: $FIREBASE_API_KEY
        FIREBASE_APP_ID: $FIREBASE_APP_ID
        FIREBASE_SERVICE_ACCOUNT_JSON: $FIREBASE_SERVICE_ACCOUNT_JSON
    
    scripts:
      - name: â¬‡ï¸ ØªØ«Ø¨ÙŠØª Flutter
        script: |
          export FLUTTER_HOME="$HOME/programs/flutter"
          rm -rf $FLUTTER_HOME
          git clone https://github.com/flutter/flutter.git -b $FLUTTER_VERSION $FLUTTER_HOME
          export PATH="$FLUTTER_HOME/bin:$PATH"
          flutter doctor -v

      - name: ðŸ› ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Gradle (Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ©)
        script: |
          if [ ! -d "android" ]; then
            flutter create --platforms android .
          fi
          
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† plugins block
          echo "buildscript {
            ext {
                kotlin_version = '$KOTLIN_VERSION'
            }
            repositories {
                google()
                mavenCentral()
            }
            dependencies {
                classpath 'com.android.tools.build:gradle:$GRADLE_VERSION'
                classpath \"org.jetbrains.kotlin:kotlin-gradle-plugin:\$kotlin_version\"
            }
          }

          allprojects {
            repositories {
                google()
                mavenCentral()
            }
          }

          task clean(type: Delete) {
            delete rootProject.buildDir
          }" > android/build.gradle

          echo "distributionUrl=https\://services.gradle.org/distributions/gradle-$GRADLE_VERSION-bin.zip" > android/gradle/wrapper/gradle-wrapper.properties
          
          echo "flutter.sdk=$FLUTTER_HOME" > android/local.properties
          echo "sdk.dir=$ANDROID_SDK_ROOT" >> android/local.properties
          chmod +x android/gradlew

      - name: ðŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
        script: |
          flutter pub get
          cd android && ./gradlew clean --stacktrace && cd ..

      - name: ðŸ—ï¸ Ø¨Ù†Ø§Ø¡ APK
        script: |
          flutter build apk --release \
            --dart-define=FIREBASE_API_KEY=$FIREBASE_API_KEY \
            --dart-define=FIREBASE_APP_ID=$FIREBASE_APP_ID \
            --verbose

      - name: ðŸš€ Ø§Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ Firebase
        script: |
          echo "$FIREBASE_SERVICE_ACCOUNT_JSON" > /tmp/firebase_account.json
          firebase appdistribution:distribute \
            build/app/outputs/flutter-apk/app-release.apk \
            --app $FIREBASE_APP_ID \
            --groups "testers" \
            --service-account-json /tmp/firebase_account.json
    
    artifacts:
      - build/app/outputs/**/*.apk
    cache:
      cache_paths:
        - ~/.gradle/caches
        - ~/.pub-cache
