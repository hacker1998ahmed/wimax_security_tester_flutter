workflows:
  android_production:
    name: ðŸš€ Android Production Build
    environment:
      vars:
        FLUTTER_VERSION: "3.22.2"
        FIREBASE_API_KEY: $FIREBASE_API_KEY
        FIREBASE_APP_ID: $FIREBASE_APP_ID
        FIREBASE_SERVICE_ACCOUNT_JSON: $FIREBASE_SERVICE_ACCOUNT_JSON
    scripts:
      # Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª Gradle Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙÙ‚ÙˆØ¯Ø©
      - name: ðŸ” Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª Gradle
        script: |
          if [ ! -f "android/gradlew" ]; then
            echo "âš ï¸ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª Gradle..."
            flutter create --platforms android .
            chmod +x android/gradlew
            echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª Gradle Ø¨Ù†Ø¬Ø§Ø­!"
          else
            echo "âœ”ï¸ Ù…Ù„ÙØ§Øª Gradle Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„."
          fi

      # Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø©
      - name: ðŸ› ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø©
        script: |
          flutter version $FLUTTER_VERSION
          flutter doctor -v
          
          # Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© ØªØ«Ø¨ÙŠØª firebase-tools Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ù…Ø³Ø¨Ù‚Ø§Ù‹
          if [ -f "/usr/local/bin/firebase" ]; then
            echo "âš ï¸ Ø­Ø°Ù Ø¥ØµØ¯Ø§Ø± firebase-tools Ø§Ù„Ù‚Ø¯ÙŠÙ…..."
            rm -f /usr/local/bin/firebase
          fi
          npm install -g firebase-tools@latest --force --unsafe-perm

      # Ø§Ù„Ø®Ø·ÙˆØ© 3: ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ±Ø§Ø®ÙŠØµ
      - name: ðŸ“œ ØªÙØ¹ÙŠÙ„ ØªØ±Ø§Ø®ÙŠØµ Android
        script: |
          yes | sdkmanager --licenses || true
          flutter doctor --android-licenses

      # Ø§Ù„Ø®Ø·ÙˆØ© 4: ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
      - name: ðŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
        script: |
          flutter clean
          rm -rf android/app/src/main/java/io/flutter/plugins/
          rm -rf android/app/src/main/kotlin/io/flutter/
          rm -rf android/.gradle
          rm -rf android/build

      # Ø§Ù„Ø®Ø·ÙˆØ© 5: Ø¥ØµÙ„Ø§Ø­ Ù…Ù„ÙØ§Øª Gradle
      - name: ðŸ”§ Ø¥ØµÙ„Ø§Ø­ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡
        script: |
          # Ø¥ØµÙ„Ø§Ø­ Ù…Ù„Ù android/app/build.gradle
          sed -i '' '/android()/d' android/app/build.gradle
          
          # ØªØ­Ø¯ÙŠØ« Ø¥ØµØ¯Ø§Ø±Ø§Øª SDK ÙÙŠ Ù…Ù„Ù android/app/build.gradle
          sed -i '' 's/compileSdkVersion [0-9]*/compileSdkVersion 34/g' android/app/build.gradle
          sed -i '' 's/targetSdkVersion [0-9]*/targetSdkVersion 34/g' android/app/build.gradle
          sed -i '' 's/minSdkVersion [0-9]*/minSdkVersion 21/g' android/app/build.gradle
          
          # ØªØ­Ø¯ÙŠØ« Ø¥ØµØ¯Ø§Ø± Gradle ÙÙŠ android/build.gradle
          sed -i '' 's/com.android.tools.build:gradle:[0-9\.]*/com.android.tools.build:gradle:7.3.0/g' android/build.gradle

      # Ø§Ù„Ø®Ø·ÙˆØ© 6: ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
      - name: ðŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
        script: |
          flutter pub get
          ./android/gradlew clean -p android

      # Ø§Ù„Ø®Ø·ÙˆØ© 7: Ø¨Ù†Ø§Ø¡ APK
      - name: ðŸ—ï¸ Ø¨Ù†Ø§Ø¡ APK
        script: |
          set -e
          flutter build apk --release \
            --dart-define=FIREBASE_API_KEY=$FIREBASE_API_KEY \
            --dart-define=FIREBASE_APP_ID=$FIREBASE_APP_ID \
            --split-debug-info=./debug_info \
            --verbose

          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          if [ -f "$APK_PATH" ]; then
            echo "âœ… ØªÙ… Ø¨Ù†Ø§Ø¡ APK Ø¨Ù†Ø¬Ø§Ø­!"
            ls -la build/app/outputs/flutter-apk/
          else
            echo "âŒ ÙØ´Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡!"
            find . -name "*.apk"
            exit 1
          fi

      # Ø§Ù„Ø®Ø·ÙˆØ© 8: Ø§Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ Firebase
      - name: ðŸ“¤ Ù†Ø´Ø± Ø¹Ù„Ù‰ Firebase
        script: |
          echo "$FIREBASE_SERVICE_ACCOUNT_JSON" > /tmp/service-account.json
          firebase appdistribution:distribute \
            build/app/outputs/flutter-apk/app-release.apk \
            --app $FIREBASE_APP_ID \
            --service-account-json /tmp/service-account.json \
            --groups "testers" \
            --debug
    artifacts:
      - build/app/outputs/flutter-apk/*.apk
      - debug_info/**
    publishing:
      email:
        recipients:
          - "your.email@example.com"
    cache:
      cache_paths:
        - ~/.gradle/caches
        - ~/.pub-cache
