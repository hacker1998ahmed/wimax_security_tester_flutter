workflows:
  android-release:
    name: Android Release Workflow
    environment:
      vars:
        FLUTTER_VERSION: "3.32.4"
      flutter: $FLUTTER_VERSION
    scripts:
      # ========== مرحلة الإعداد ==========
      - name: Set Up Environment
        script: |
          echo "=== تنظيف البيئة ==="
          flutter channel stable
          flutter upgrade --force
          flutter clean
          
          echo "=== الانتقال إلى مجلد Android ==="
          cd android
          
          echo "=== تنظيف Gradle ==="
          rm -rf .gradle
          rm -rf ~/.gradle/caches
          
          echo "=== إصلاح الأذونات ==="
          find . -type f -name "*.gradle" -exec chmod 644 {} \;
          chmod +x gradlew
          
          echo "=== إيقاف عمليات Gradle ==="
          ./gradlew --stop || echo "Gradle stop failed (normal if no daemon was running)"
          
          cd ..

      # ========== تثبيت التبعيات ==========
      - name: Install Dependencies
        script: |
          echo "=== تثبيت التبعيات ==="
          flutter pub get
          
          cd android
          ./gradlew clean
          cd ..

      # ========== مرحلة البناء ==========
      - name: Build APK
        script: |
          echo "=== بناء APK ==="
          flutter build apk --release \
            --dart-define=FIREBASE_API_KEY=$FIREBASE_API_KEY \
            --dart-define=FIREBASE_APP_ID=$FIREBASE_APP_ID \
            --dart-define=FIREBASE_TOKEN=$FIREBASE_TOKEN

    artifacts:
      - build/app/outputs/flutter-apk/app-release.apk

    publishing:
      email:
        recipients:
          - your-email@example.com
