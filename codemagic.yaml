workflows:
  android_production:
    name: ğŸš€ Android Production Build
    environment:
      vars:
        FLUTTER_VERSION: "3.22.2"
        FIREBASE_API_KEY: $FIREBASE_API_KEY
        FIREBASE_APP_ID: $FIREBASE_APP_ID
        FIREBASE_SERVICE_ACCOUNT_JSON: $FIREBASE_SERVICE_ACCOUNT_JSON
    scripts:
      # Ø§Ù„Ø®Ø·ÙˆØ© 1: ØªØ«Ø¨ÙŠØª Flutter
      - name: â¬‡ï¸ ØªØ«Ø¨ÙŠØª Flutter
        script: |
          FLUTTER_HOME="$HOME/programs/flutter"
          if [ ! -d "$FLUTTER_HOME" ]; then
            git clone https://github.com/flutter/flutter.git -b $FLUTTER_VERSION $FLUTTER_HOME
          fi
          export PATH="$FLUTTER_HOME/bin:$PATH"
          flutter doctor -v

      # Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªØ­Ø¯ÙŠØ« Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡
      - name: ğŸ”§ ØªØ­Ø¯ÙŠØ« Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡
        script: |
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙÙ‚ÙˆØ¯Ø©
          if [ ! -f "android/build.gradle" ]; then
            flutter create --platforms android .
          fi

          # ØªØ­Ø¯ÙŠØ« android/build.gradle
          cat <<EOT > android/build.gradle
          buildscript {
              ext.kotlin_version = '1.9.22'
              repositories {
                  google()
                  mavenCentral()
              }
              dependencies {
                  classpath 'com.android.tools.build:gradle:7.3.0'
                  classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:\$kotlin_version"
              }
          }

          allprojects {
              repositories {
                  google()
                  mavenCentral()
              }
          }

          task clean(type: Delete) {
              delete rootProject.buildDir
          }
          EOT

          # ØªØ­Ø¯ÙŠØ« android/app/build.gradle
          cat <<EOT > android/app/build.gradle
          plugins {
              id "com.android.application"
              id "kotlin-android"
              id "dev.flutter.flutter-gradle-plugin"
          }

          def localProperties = new Properties()
          def localPropertiesFile = rootProject.file('local.properties')
          if (localPropertiesFile.exists()) {
              localPropertiesFile.withReader('UTF-8') { reader ->
                  localProperties.load(reader)
              }
          }

          def flutterRoot = localProperties.getProperty('flutter.sdk')
          if (flutterRoot == null) {
              throw new GradleException("Flutter SDK not found. Define location with flutter.sdk in local.properties.")
          }

          android {
              compileSdkVersion 34
              ndkVersion flutter.ndkVersion

              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }

              kotlinOptions {
                  jvmTarget = '17'
              }

              sourceSets {
                  main.java.srcDirs += 'src/main/kotlin'
              }

              defaultConfig {
                  applicationId "com.example.wimax_security_tester"
                  minSdkVersion 21
                  targetSdkVersion 34
                  versionCode 1
                  versionName "1.0"
              }

              buildTypes {
                  release {
                      signingConfig signingConfigs.debug
                      minifyEnabled true
                      shrinkResources true
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                  }
              }
          }

          flutter {
              source '../..'
          }

          dependencies {
              implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk7:\$kotlin_version"
          }
          EOT

          # Ø¥Ø²Ø§Ù„Ø© Ø¥Ø¹Ø¯Ø§Ø¯ R8 Ù…Ù† gradle.properties Ø¥Ø°Ø§ ÙˆØ¬Ø¯
          if [ -f "android/gradle.properties" ]; then
              sed -i '' '/android.enableR8/d' android/gradle.properties
          fi

      # Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø©
      - name: ğŸ› ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø©
        script: |
          npm install -g firebase-tools@latest --force --unsafe-perm

      # Ø§Ù„Ø®Ø·ÙˆØ© 4: ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
      - name: ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
        script: |
          flutter pub get
          ./android/gradlew clean -p android

      # Ø§Ù„Ø®Ø·ÙˆØ© 5: Ø¨Ù†Ø§Ø¡ APK
      - name: ğŸ—ï¸ Ø¨Ù†Ø§Ø¡ APK
        script: |
          set -e
          flutter build apk --release \
            --dart-define=FIREBASE_API_KEY=$FIREBASE_API_KEY \
            --dart-define=FIREBASE_APP_ID=$FIREBASE_APP_ID \
            --split-debug-info=./debug_info \
            --verbose

          if [ ! -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            echo "âŒ ÙØ´Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡ - Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ APK"
            exit 1
          fi

      # Ø§Ù„Ø®Ø·ÙˆØ© 6: Ø§Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ Firebase
      - name: ğŸ“¤ Ù†Ø´Ø± Ø¹Ù„Ù‰ Firebase
        script: |
          echo "$FIREBASE_SERVICE_ACCOUNT_JSON" > /tmp/service-account.json
          firebase appdistribution:distribute \
            build/app/outputs/flutter-apk/app-release.apk \
            --app $FIREBASE_APP_ID \
            --service-account-json /tmp/service-account.json \
            --groups "testers" \
            --debug
    artifacts:
      - build/app/outputs/flutter-apk/*.apk
      - debug_info/**
    publishing:
      email:
        recipients:
          - "your.email@example.com"
    cache:
      cache_paths:
        - ~/.gradle/caches
        - ~/.pub-cache
