workflows:
  android_production:
    name: ğŸš€ Android Production Build
    environment:
      groups:
        - firebase_credentials
      vars:
        FLUTTER_VERSION: "3.19.5"
    triggering:
      events: [push]
      branch_patterns:
        - pattern: main
          include: true
    scripts:
      - name: ğŸ› ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø©
        script: |
          flutter version $FLUTTER_VERSION
          flutter doctor -v
          
          # Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Firebase CLI
          sudo rm -f /usr/local/bin/firebase
          npm install -g firebase-tools@latest --force

      - name: ğŸ—ï¸ Ø¨Ù†Ø§Ø¡ APK
        script: |
          flutter clean
          flutter pub get
          flutter build apk --release \
            --dart-define=FIREBASE_API_KEY=$FIREBASE_API_KEY \
            --dart-define=FIREBASE_APP_ID=$FIREBASE_APP_ID \
            --split-debug-info=./debug_info
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„Ù
          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          if [ ! -f "$APK_PATH" ]; then
            echo "âŒ Error: APK file not found!"
            ls -la build/app/outputs/flutter-apk/
            exit 1
          fi

      - name: ğŸ“¤ Ù†Ø´Ø± Ø¹Ù„Ù‰ Firebase
        script: |
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… Service Account ÙƒØ¨Ø¯ÙŠÙ„ Ø¢Ù…Ù†
          firebase appdistribution:distribute \
            build/app/outputs/flutter-apk/app-release.apk \
            --app $FIREBASE_APP_ID \
            --service-account-json "$FIREBASE_SERVICE_ACCOUNT_JSON" \
            --groups "testers" \
            --debug
    artifacts:
      - build/app/outputs/flutter-apk/*.apk
      - debug_info/**
    publishing:
      email:
        recipients:
          - "your-email@example.com"
        notify:
          success: true
          failure: true
    cache:
      cache_paths:
        - ~/.gradle/caches
        - ~/.pub-cache
