workflows:
  android_production:
    name: ğŸš€ Android Production Build
    environment:
      groups:
        - firebase_credentials  # Ù„Ù…ØªØºÙŠØ±Ø§Øª Firebase
      vars:
        FLUTTER_VERSION: "3.22.2"  # Ø£Ø­Ø¯Ø« Ø¥ØµØ¯Ø§Ø± Ù…Ø³ØªÙ‚Ø±
        BUILD_NUMBER: 1  # ÙŠÙ…ÙƒÙ† Ø²ÙŠØ§Ø¯ØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
          include: true
    scripts:
      # ======================
      # 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø©
      # ======================
      - name: ğŸ› ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø©
        script: |
          flutter version $FLUTTER_VERSION
          flutter doctor -v
          
          # Ø¥ØµÙ„Ø§Ø­ ØªØ¨Ø¹ÙŠØ§Øª npm/firebase
          npm install -g firebase-tools@latest --force
          firebase --version

      # ======================
      # 2. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
      # ======================
      - name: ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø´Ø§Ù…Ù„
        script: |
          flutter clean
          rm -rf android/app/src/main/java/io/flutter/plugins/
          rm -rf android/app/src/main/kotlin/io/flutter/

      # ======================
      # 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
      # ======================
      - name: ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
        script: |
          flutter pub upgrade --major-versions
          cd android && ./gradlew clean

      # ======================
      # 4. Ø¨Ù†Ø§Ø¡ APK
      # ======================
      - name: ğŸ—ï¸ Ø¨Ù†Ø§Ø¡ APK
        script: |
          flutter build apk --release \
            --dart-define=FIREBASE_API_KEY=$FIREBASE_API_KEY \
            --dart-define=FIREBASE_APP_ID=$FIREBASE_APP_ID \
            --split-debug-info=./debug_info \
            --obfuscate \
            --verbose
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„Ù
          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          if [ -f "$APK_PATH" ]; then
            echo "âœ” ØªÙ… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­! Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù:"
            du -h "$APK_PATH"
          else
            echo "âŒ ÙØ´Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡ - Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ APK"
            ls -la build/app/outputs/flutter-apk/
            exit 1
          fi

      # ======================
      # 5. Ø§Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ Firebase
      # ======================
      - name: ğŸ“¤ Ù†Ø´Ø± Ø¹Ù„Ù‰ Firebase
        script: |
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… Service Account Ø§Ù„Ø¢Ù…Ù†
          echo "$FIREBASE_SERVICE_ACCOUNT_JSON" > /tmp/service-account.json
          
          firebase appdistribution:distribute \
            build/app/outputs/flutter-apk/app-release.apk \
            --app $FIREBASE_APP_ID \
            --service-account-json /tmp/service-account.json \
            --groups "testers" \
            --debug

    # ======================
    # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª
    # ======================
    artifacts:
      - build/app/outputs/flutter-apk/*.apk
      - debug_info/**

    publishing:
      email:
        recipients:
          - "your.email@example.com"  # âš ï¸ Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨Ø±ÙŠØ¯Ùƒ
        notify:
          success: true
          failure: true

    # ======================
    # ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
    # ======================
    cache:
      cache_paths:
        - ~/.gradle/caches
        - ~/.pub-cache
        - /tmp/service-account.json
