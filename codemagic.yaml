workflows:
  android_production:
    name: ğŸš€ Android Production Build
    environment:
      groups:
        - flutter
        - firebase
      vars:
        FLUTTER_VERSION: "3.22.2"
        GRADLE_VERSION: "8.1.0"
        KOTLIN_VERSION: "1.9.22"
    scripts:
      # Ø§Ù„Ø®Ø·ÙˆØ© 1: ØªØ«Ø¨ÙŠØª Flutter Ù…Ø¹ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
      - name: â¬‡ï¸ ØªØ«Ø¨ÙŠØª Flutter
        script: |
          export FLUTTER_HOME="$HOME/programs/flutter"
          if [ ! -d "$FLUTTER_HOME" ]; then
            git clone https://github.com/flutter/flutter.git -b $FLUTTER_VERSION $FLUTTER_HOME
          fi
          export PATH="$FLUTTER_HOME/bin:$PATH"
          flutter config --enable-web
          flutter doctor -v

      # Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¥Ø¹Ø¯Ø§Ø¯ Gradle Ù…Ø¹ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª
      - name: ğŸ› ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Gradle
        script: |
          echo "systemProp.gradle.parallel=true" > ~/.gradle/gradle.properties
          echo "org.gradle.daemon=true" >> ~/.gradle/gradle.properties
          
          # ØªØ­Ø¯ÙŠØ« Ù…Ù„Ù gradle-wrapper.properties
          sed -i '' "s/gradle-.*.zip/gradle-$GRADLE_VERSION-bin.zip/g" android/gradle-wrapper.properties
          
          # ØªØ­Ø¯ÙŠØ« build.gradle
          sed -i '' "s/kotlin_version = .*/kotlin_version = '$KOTLIN_VERSION'/g" android/build.gradle
          sed -i '' "s/com.android.tools.build:gradle:.*/com.android.tools.build:gradle:$GRADLE_VERSION/g" android/build.gradle

      # Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø© Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
      - name: âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø©
        script: |
          npm install -g firebase-tools@latest --force --unsafe-perm
          export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
          export PATH=$JAVA_HOME/bin:$PATH

      # Ø§Ù„Ø®Ø·ÙˆØ© 4: ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
      - name: ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
        script: |
          flutter pub upgrade --major-versions
          
          # Ø­Ù„ Ø¨Ø¯ÙŠÙ„ Ø¥Ø°Ø§ ÙØ´Ù„ flutter pub get
          if ! flutter pub get; then
            echo "âš ï¸ Retrying with --no-sound-null-safety"
            flutter pub get --no-sound-null-safety
          fi
          
          # ØªÙ†Ø¸ÙŠÙ Ù…Ø´Ø±ÙˆØ¹ Gradle
          cd android && ./gradlew clean && cd ..

      # Ø§Ù„Ø®Ø·ÙˆØ© 5: Ø¨Ù†Ø§Ø¡ APK Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª
      - name: ğŸ—ï¸ Ø¨Ù†Ø§Ø¡ APK
        script: |
          set -e
          flutter build apk --release \
            --dart-define=FIREBASE_API_KEY=$FIREBASE_API_KEY \
            --dart-define=FIREBASE_APP_ID=$FIREBASE_APP_ID \
            --split-debug-info=./debug_info \
            --obfuscate \
            --split-per-abi \
            --verbose

          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†Ø§ØªØ¬
          if [ ! -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            echo "âŒ ÙØ´Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡ - Ø¬Ø±Ø¨ Ø¨Ù†Ø§Ø¡ debug Ø£ÙˆÙ„Ø§Ù‹"
            flutter build apk --debug
            exit 1
          fi

      # Ø§Ù„Ø®Ø·ÙˆØ© 6: Ø§Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ Firebase Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
      - name: ğŸ“¤ Ù†Ø´Ø± Ø¹Ù„Ù‰ Firebase
        script: |
          echo "$FIREBASE_SERVICE_ACCOUNT_JSON" > /tmp/service-account.json
          
          if ! firebase appdistribution:distribute \
            build/app/outputs/flutter-apk/app-release.apk \
            --app $FIREBASE_APP_ID \
            --service-account-json /tmp/service-account.json \
            --groups "testers"; then
            
            echo "âš ï¸ ÙØ´Ù„ Ø§Ù„Ù†Ø´Ø± - Ø¬Ø±Ø¨ ØªØ­Ù…ÙŠÙ„ APK ÙŠØ¯ÙˆÙŠØ§Ù‹"
            exit 0
          fi
    artifacts:
      - build/app/outputs/**/*.apk
      - debug_info/**
    publishing:
      email:
        recipients:
          - "your.email@example.com"
    cache:
      cache_paths:
        - ~/.gradle/caches
        - ~/.pub-cache
        - $FLUTTER_HOME/.pub-cache
