workflows:
  android_production:
    name: ðŸš€ Android Production Build
    environment:
      vars:
        FLUTTER_VERSION: "3.22.2"  # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø­Ø¯Ø« Ø¥ØµØ¯Ø§Ø± Ù…Ø³ØªÙ‚Ø±
        FIREBASE_API_KEY: $FIREBASE_API_KEY
        FIREBASE_APP_ID: $FIREBASE_APP_ID
        FIREBASE_SERVICE_ACCOUNT_JSON: $FIREBASE_SERVICE_ACCOUNT_JSON
    scripts:
      - name: ðŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø´Ø§Ù…Ù„
        script: |
          flutter clean
          rm -rf android/
          rm -rf ios/
          rm -rf .flutter-plugins
          rm -rf .flutter-plugins-dependencies

      - name: ðŸ› ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø© Ù…Ù† Ø§Ù„ØµÙØ±
        script: |
          flutter version $FLUTTER_VERSION
          flutter doctor -v
          
          # Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
          flutter create --platforms android --org com.yourcompany .
          
          flutter pub get
          npm install -g firebase-tools@latest --force

      - name: ðŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
        script: |
          flutter pub upgrade --major-versions
          cd android && ./gradlew clean

      - name: ðŸ—ï¸ Ø¨Ù†Ø§Ø¡ APK Ù†Ù‡Ø§Ø¦ÙŠ
        script: |
          flutter build apk --release \
            --dart-define=FIREBASE_API_KEY=$FIREBASE_API_KEY \
            --dart-define=FIREBASE_APP_ID=$FIREBASE_APP_ID \
            --verbose
          
          if [ ! -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            echo "âŒ ÙØ´Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡ - Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ APK"
            echo "ðŸ” Ù…Ø­ØªÙˆÙŠØ§Øª Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¨Ù†Ø§Ø¡:"
            ls -la build/app/outputs/ || true
            exit 1
          else
            echo "âœ” ØªÙ… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!"
            du -h build/app/outputs/flutter-apk/app-release.apk
          fi

      - name: ðŸ“¤ Ù†Ø´Ø± Ø¹Ù„Ù‰ Firebase
        script: |
          echo "$FIREBASE_SERVICE_ACCOUNT_JSON" > /tmp/service-account.json
          firebase appdistribution:distribute \
            build/app/outputs/flutter-apk/app-release.apk \
            --app $FIREBASE_APP_ID \
            --service-account-json /tmp/service-account.json \
            --groups "testers" \
            --debug
    artifacts:
      - build/app/outputs/flutter-apk/*.apk
    publishing:
      email:
        recipients:
          - "gogom8870@gmail.com"
        notify:
          success: true
          failure: true
