################################################################
# WiMax Security Tester - Flutter Production Build
# ØªÙ… Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ù„ÙŠØ¹Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ÙØ±Ø¯ÙŠØ© Ø¨Ø¯ÙˆÙ† Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
################################################################

workflows:
  android_production:
    name: ğŸš€ Android Production Build
    environment:
      vars:  # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØªØºÙŠØ±Ø§Øª ÙØ±Ø¯ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø©
        ENCODED_KEYSTORE: $ENCODED_KEYSTORE
        STORE_PWD: $STORE_PWD
        KEY_PWD: $KEY_PWD
        KEY_ALIAS: $KEY_ALIAS
        FIREBASE_API_KEY: $FIREBASE_API_KEY
        FIREBASE_APP_ID: $FIREBASE_APP_ID
        FIREBASE_TOKEN: $FIREBASE_TOKEN
    triggering:
      events: [push]
      branch_patterns:
        - pattern: main
          include: true
    scripts:
      # ======================
      # 1. Ø¥Ø¹Ø¯Ø§Ø¯ ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
      # ======================
      - name: ğŸ” Ø¥Ø¹Ø¯Ø§Ø¯ Keystore
        script: |
          mkdir -p android/app/keystore
          echo $ENCODED_KEYSTORE | base64 --decode > android/app/keystore/release.jks
          chmod 600 android/app/keystore/release.jks
          echo "âœ” ØªÙ… ØªØ­Ø¶ÙŠØ± Ù…Ù„Ù Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­"

      # ======================
      # 2. Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
      # ======================
      - name: ğŸ› ï¸ Ø¨Ù†Ø§Ø¡ Ø­Ø²Ù…Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        script: |
          flutter pub get
          flutter build appbundle --release \
            --dart-define=FIREBASE_API_KEY=$FIREBASE_API_KEY \
            --dart-define=FIREBASE_APP_ID=$FIREBASE_APP_ID \
            --obfuscate \
            --split-debug-info=./debug_info
          echo "âœ” ØªÙ… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­"

      # ======================
      # 3. Ù†Ø´Ø± Ø¹Ù„Ù‰ Firebase
      # ======================
      - name: ğŸ“¤ Ø§Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ Firebase
        script: |
          npm install -g firebase-tools
          firebase appdistribution:distribute \
            build/app/outputs/bundle/release/*.aab \
            --app $FIREBASE_APP_ID \
            --token "$FIREBASE_TOKEN" \
            --groups "testers"
          echo "âœ” ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ Firebase Ø¨Ù†Ø¬Ø§Ø­"

    artifacts:
      - build/app/outputs/bundle/release/*.aab
      - debug_info/

    publishing:
      email:
        recipients:
          - "gogom8870@gmail.com"  # âš ï¸ Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„ÙØ¹Ù„ÙŠ
        notify:
          success: true
          failure: true
